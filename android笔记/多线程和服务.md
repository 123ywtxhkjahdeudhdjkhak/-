## 一、异步消息处理

原因：和其他的GUI库一样，Android中的UI是线程不安全，如果想要更新应用程序中的UI元素，则必须在主线程中进行，否则就会出异常。

异步消息处理机制：Android中的异步消息处理主要由4部分组成：Message、Handler、MessageQueue和Loopper。其中Message是线程之间传递的消息，可以在内部携带少量的信息。Handler是用来发送和处理信息的，发送消息通常由使用该类中的sendMessage()方法发送Message实例，发送的信息经过一系列地辗转处理后最终会传递到Handler的handleMessage()方法中。MessageQueue是消息队列，主要用于存放所有通过Handler发送的消息，这部分消息会一直存在于消息队列中，等待被处理。每个线程只会有一个MessageQueue对象。Looper是每个线程中MessageQueue的管家，调用Looper的loop方法后就会进入到一个监听MessageQueue的无限循环中，每当MessageQueue中存在消息，就会将它取出，并回调dispatchMessage()方法传递到关联的Handler的handMessage()方法中。

实现：通过匿名内部类的方式创建一个Handler的对象，重写父类的handleMessage()方法，该方法有一个Message参数，通过该Message中的信息执行对应的操作。创建一个Message(可空参构造)对象，然后调用该对象的成员变量或方法设置信息，调用前面创建的Handler对象中的sendMessage()方法将这条Message对象发送出去，之后这条信息会被添加到MessageQueue的队列中等待被处理，Looper会一直尝试从MessageQueue中取出待处理消息，最后分发回Handler中的handleMessage()方法中对它进行处理，该方法会根据Message中的信息执行对应的操作。此时的handleMessage方法是在主线程当中运行的，所以可以在这里进行UI操作。创建Handler时如果不指定关联则会自动关联到创建当前对象的线程，子线程中默认没有Looper，如果在子线程中直接创建不指定关联Loopper的Handler会报错，想要在子进程中创建Handler则需要使用带参的Handler去指定关联的Lopper或如果想要绑定到当前子线程则需要在创建Handler前先执行 Looper.prepare()方法创建Lopper，最后调用Looper.loop()启动Looper 的消息循环。

## 二、服务

定义：服务是android中实现程序后台运行的解决方案，适合不需要和用户进行交互且长期运行的任务。服务的运行不依赖于任何用户界面，即使程序被切换到后台，或者用户打开另一个应用程序，服务仍能保持正常运行。服务不是运行在独立的进程中，而是依赖于创建时所在的应用程序进程，当应用进程被杀掉时，所有依赖于该进程的服务也会停止运行。服务不会自动开启线程，所有的代码都默认运行在主线程中。

使用场景：不需要和用户交互且长时间运行的后台任务

实现：创建一个继承Sevice的子类，实现onBInd(Intent intent)抽象方法，然后在清单文件中注册声明。重写onCreate()、onStartCommand()、onDestroy()3个方法。其中onCreate()方法会在服务创建时调用，onStartCommand()方法会在每次服务启动时调用，onDestroy()方法会在服务销毁时调用。